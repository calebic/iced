generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DeveloperStatus {
  active
  disabled
}

enum ApplicationStatus {
  active
  disabled
}

enum RegistrationFieldPolicy {
  required
  optional
  disabled
}

enum EndUserStatus {
  active
  disabled
}

enum LicenseStatus {
  active
  redeemed
  revoked
  expired
}

enum ActorType {
  owner
  developer
  end_user
}

enum WebhookDeliveryStatus {
  pending
  sent
  failed
}

model OwnerUser {
  id           String         @id @default(uuid()) @db.Uuid
  email        String         @unique
  passwordHash String         @map("password_hash")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  sessions     OwnerSession[]

  @@map("owner_users")
}

model OwnerSession {
  id               String     @id @default(uuid()) @db.Uuid
  ownerUserId      String     @map("owner_user_id") @db.Uuid
  sessionTokenHash String     @map("session_token_hash")
  createdAt        DateTime   @default(now()) @map("created_at")
  expiresAt        DateTime   @map("expires_at")
  revokedAt        DateTime?  @map("revoked_at")

  ownerUser        OwnerUser  @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)

  @@index([ownerUserId])
  @@index([expiresAt])
  @@map("owner_sessions")
}

model DeveloperUser {
  id                 String            @id @default(uuid()) @db.Uuid
  username           String            @map("username")
  usernameNormalized String            @unique @map("username_normalized")
  email              String            @unique
  passwordHash       String            @map("password_hash")
  status             DeveloperStatus   @default(active)
  disabledAt         DateTime?         @map("disabled_at")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  sessions     DeveloperSession[]
  applications Application[]

  @@index([status])
  @@map("developer_users")
}

model DeveloperSession {
  id               String         @id @default(uuid()) @db.Uuid
  developerUserId  String         @map("developer_user_id") @db.Uuid
  sessionTokenHash String         @map("session_token_hash")
  createdAt        DateTime       @default(now()) @map("created_at")
  expiresAt        DateTime       @map("expires_at")
  revokedAt        DateTime?      @map("revoked_at")

  developerUser    DeveloperUser  @relation(fields: [developerUserId], references: [id], onDelete: Cascade)

  @@index([developerUserId])
  @@index([expiresAt])
  @@map("developer_sessions")
}

model Application {
  id                         String             @id @default(uuid()) @db.Uuid
  developerUserId            String             @map("developer_user_id") @db.Uuid
  name                       String
  status                     ApplicationStatus  @default(active)
  allowedOrigins             String[]           @default([]) @map("allowed_origins")
  accessTokenTtlSeconds      Int                @map("access_token_ttl_seconds")
  refreshTokenTtlSeconds     Int                @map("refresh_token_ttl_seconds")
  emailPolicy                RegistrationFieldPolicy @default(required) @map("email_policy")
  licensePolicy              RegistrationFieldPolicy @default(optional) @map("license_policy")
  defaultRankId              String?            @map("default_rank_id") @db.Uuid
  createdAt                  DateTime           @default(now()) @map("created_at")
  updatedAt                  DateTime           @updatedAt @map("updated_at")

  developerUser              DeveloperUser      @relation(fields: [developerUserId], references: [id], onDelete: Cascade)
  apiKeys                    ApiKey[]
  endUsers                   EndUser[]
  ranks                      Rank[]
  permissions                Permission[]
  licenses                   License[]
  licensePools               LicensePool[]
  auditLogs                  AuditLog[]
  eventLogs                  EventLog[]
  webhooks                   Webhook[]
  webhookDeliveries          WebhookDelivery[]
  defaultRank                Rank?              @relation("DefaultRank", fields: [defaultRankId], references: [id], onDelete: SetNull)

  @@index([developerUserId])
  @@index([status])
  @@map("applications")
}

// License pools do not have a direct EventLog relation.
model LicensePool {
  id            String       @id @default(uuid()) @db.Uuid
  applicationId String       @map("application_id") @db.Uuid
  name          String
  description   String?
  createdAt     DateTime     @default(now()) @map("created_at")

  application   Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  licenses      License[]

  @@unique([applicationId, name])
  @@index([applicationId])
  @@map("license_pools")
}

model ApiKey {
  id            String       @id @default(uuid()) @db.Uuid
  applicationId String       @map("application_id") @db.Uuid
  keyHash       String       @unique @map("key_hash")
  apiKeyLast4   String?      @map("api_key_last4")
  apiKeyCreatedAt DateTime?  @map("api_key_created_at")
  apiKeyLastUsedAt DateTime? @map("api_key_last_used_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  revokedAt     DateTime?    @map("revoked_at")
  lastUsedAt    DateTime?    @map("last_used_at")

  application   Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  eventLogs     EventLog[]   @relation("ApiKeyEventLogs")

  @@index([applicationId])
  @@map("api_keys")
}

model EndUser {
  id           String                @id @default(uuid()) @db.Uuid
  applicationId String               @map("application_id") @db.Uuid
  rankId       String?               @map("rank_id") @db.Uuid
  username     String
  usernameNormalized String          @map("username_normalized")
  email        String?
  passwordHash String                @map("password_hash")
  rankExpiresAt DateTime?            @map("rank_expires_at")
  rankSourceLicenseId String?        @map("rank_source_license_id") @db.Uuid
  status       EndUserStatus         @default(active)
  bannedUntil  DateTime?             @map("banned_until")
  banReason    String?               @map("ban_reason")
  bannedAt     DateTime?             @map("banned_at")
  createdAt    DateTime              @default(now()) @map("created_at")
  updatedAt    DateTime              @updatedAt @map("updated_at")
  lastLoginAt  DateTime?             @map("last_login_at")

  application  Application           @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  rank         Rank?                 @relation(fields: [rankId], references: [id], onDelete: SetNull)
  rankSourceLicense License?         @relation("RankSourceLicense", fields: [rankSourceLicenseId], references: [id], onDelete: SetNull)
  refreshTokens EndUserRefreshToken[]
  redeemedLicenses License[]         @relation("LicenseRedeemer")

  @@unique([applicationId, email])
  @@unique([applicationId, usernameNormalized])
  @@index([applicationId])
  @@index([status])
  @@index([rankId])
  @@map("end_users")
}

model EndUserRefreshToken {
  id            String     @id @default(uuid()) @db.Uuid
  endUserId     String     @map("end_user_id") @db.Uuid
  tokenHash     String     @unique @map("token_hash")
  createdAt     DateTime   @default(now()) @map("created_at")
  expiresAt     DateTime   @map("expires_at")
  revokedAt     DateTime?  @map("revoked_at")
  replacedById  String?    @map("replaced_by_id") @db.Uuid

  endUser       EndUser    @relation(fields: [endUserId], references: [id], onDelete: Cascade)
  replacedBy    EndUserRefreshToken? @relation("RefreshTokenRotation", fields: [replacedById], references: [id])
  replacedToken EndUserRefreshToken? @relation("RefreshTokenRotation")

  @@index([endUserId])
  @@index([expiresAt])
  @@unique([replacedById])
  @@map("end_user_refresh_tokens")
}

model Rank {
  id            String        @id @default(uuid()) @db.Uuid
  applicationId String        @map("application_id") @db.Uuid
  name          String
  description   String?
  priority      Int
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  application   Application   @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  permissions   RankPermission[]
  licenses      License[]
  defaultFor    Application[] @relation("DefaultRank")
  endUsers      EndUser[]

  @@unique([applicationId, name])
  @@index([applicationId])
  @@map("ranks")
}

model Permission {
  id            String           @id @default(uuid()) @db.Uuid
  applicationId String           @map("application_id") @db.Uuid
  name          String
  description   String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  application   Application      @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  ranks         RankPermission[]

  @@unique([applicationId, name])
  @@index([applicationId])
  @@map("permissions")
}

model RankPermission {
  rankId       String      @map("rank_id") @db.Uuid
  permissionId String      @map("permission_id") @db.Uuid

  rank         Rank        @relation(fields: [rankId], references: [id], onDelete: Cascade)
  permission   Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([rankId, permissionId])
  @@map("rank_permissions")
}

model License {
  id            String        @id @default(uuid()) @db.Uuid
  applicationId String        @map("application_id") @db.Uuid
  rankId        String        @map("rank_id") @db.Uuid
  poolId        String?       @map("pool_id") @db.Uuid
  codeHash      String        @unique @map("code_hash")
  status        LicenseStatus @default(active)
  maxUses       Int?          @map("max_uses")
  useCount      Int           @default(0) @map("use_count")
  durationSeconds Int?        @map("duration_seconds")
  expiresAt     DateTime?     @map("expires_at")
  redeemedAt    DateTime?     @map("redeemed_at")
  redeemedById  String?       @map("redeemed_by_id") @db.Uuid
  revokedAt     DateTime?     @map("revoked_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  application   Application   @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  rank          Rank          @relation(fields: [rankId], references: [id], onDelete: Restrict)
  pool          LicensePool?  @relation(fields: [poolId], references: [id], onDelete: SetNull)
  redeemedBy    EndUser?      @relation("LicenseRedeemer", fields: [redeemedById], references: [id], onDelete: SetNull)
  rankSourceEndUsers EndUser[] @relation("RankSourceLicense")

  @@index([applicationId])
  @@index([poolId])
  @@index([status])
  @@map("licenses")
}

model AuditLog {
  id         String     @id @default(uuid()) @db.Uuid
  actorType  ActorType  @map("actor_type")
  actorId    String     @map("actor_id") @db.Uuid
  appId      String?    @map("app_id") @db.Uuid
  action     String
  metadata   Json       @default("{}")
  createdAt  DateTime   @default(now()) @map("created_at")

  application Application? @relation(fields: [appId], references: [id], onDelete: SetNull)

  @@index([actorType, actorId])
  @@index([appId])
  @@index([createdAt])
  @@map("audit_logs")
}

model EventLog {
  id         String   @id @default(uuid()) @db.Uuid
  appId      String   @map("app_id") @db.Uuid
  eventType  String   @map("event_type")
  requestId  String   @map("request_id")
  ip         String   @map("ip")
  userAgent  String   @map("user_agent")
  method     String   @map("method")
  path       String   @map("path")
  statusCode Int      @map("status_code")
  apiKeyId   String?  @map("api_key_id") @db.Uuid
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")

  application Application @relation(fields: [appId], references: [id], onDelete: Cascade)
  apiKey      ApiKey?      @relation("ApiKeyEventLogs", fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([appId])
  @@index([eventType])
  @@index([createdAt])
  @@map("event_logs")
}

model Webhook {
  id            String   @id @default(uuid()) @db.Uuid
  appId         String   @map("app_id") @db.Uuid
  url           String
  secretCipher  String   @map("secret_cipher")
  enabled       Boolean  @default(true)
  events        String[]
  createdAt     DateTime @default(now()) @map("created_at")

  application   Application       @relation(fields: [appId], references: [id], onDelete: Cascade)
  deliveries    WebhookDelivery[]

  @@index([appId])
  @@map("webhooks")
}

model WebhookDelivery {
  id             String                @id @default(uuid()) @db.Uuid
  webhookId      String                @map("webhook_id") @db.Uuid
  appId          String                @map("app_id") @db.Uuid
  eventType      String                @map("event_type")
  payloadJson    Json                  @map("payload_json")
  status         WebhookDeliveryStatus @default(pending)
  attemptCount   Int                   @default(0) @map("attempt_count")
  nextAttemptAt  DateTime              @map("next_attempt_at")
  lastError      String?               @map("last_error")
  lastStatusCode Int?                  @map("last_status_code")
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")

  webhook        Webhook               @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  application    Application           @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([webhookId])
  @@index([status])
  @@index([nextAttemptAt])
  @@map("webhook_deliveries")
}
